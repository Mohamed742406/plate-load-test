<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform: Plate Load Test (ASTM & DIN)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© --- */
        body { font-family: 'Cairo', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .main-nav { background: #2c3e50; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: sticky; top:0; z-index: 1000; }
        .std-btn { 
            background: transparent; color: #ecf0f1; border: 2px solid #ecf0f1; 
            padding: 8px 25px; margin: 0 10px; border-radius: 30px; 
            font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1.1em;
        }
        .std-btn:hover, .std-btn.active { background: #e67e22; color: white; border-color: #e67e22; transform: scale(1.05); }
        
        /* Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª */
        .view-section { display: none; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù†ÙØ³ Ø§Ù„Ù‚Ø¯ÙŠÙ…) */
        .report-container { max-width: 210mm; margin: 30px auto; background: white; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.1); min-height: 297mm; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
        th, td { border: 1px solid #333; padding: 6px 8px; text-align: center; font-size: 12px; vertical-align: middle; }
        th { background-color: #e8e8e8; font-weight: bold; line-height: 1.4; }
        
        /* Ø§Ù„Ù†ØµÙˆØµ */
        .ar-text { font-weight: 700; font-size: 1em; color: #1a1a1a; display: block; }
        .en-sub { font-size: 0.75em; color: #555; font-weight: normal; display: block; margin-top: 2px; }
        .bilingual-label { text-align: center; line-height: 1.3; }
        .label-cell { background-color: #f5f5f5; font-weight: bold; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input[type="text"], input[type="number"], input[type="date"] {
            border: none; border-bottom: 1px solid #999; padding: 4px; width: 100%; text-align: center; background: transparent; font-family: 'Cairo', Arial, sans-serif;
        }
        input:focus { outline: none; border-bottom-color: #0066cc; }
        input[readonly] { background-color: #e8f4fc; border-bottom: 2px solid #0066cc; font-weight: bold; color: #0066cc; }
        
        .section-title { background-color: #d4d4d4; padding: 10px 12px; font-weight: bold; border: 1px solid #333; margin-top: 20px; text-align: center; }
        .calculated { background-color: #f0f8ff; }
        .stress-calculated { background-color: #e8f5e9; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 8px 16px; margin: 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; font-family: 'Cairo'; }
        .btn-primary { background-color: #0066cc; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-info { background-color: #17a2b8; color: white; }
        
        .header-logo { border: 2px solid #333; padding: 20px; text-align: center; }
        
        .tabs-nav { display: flex; border-bottom: 3px solid #0066cc; margin-bottom: 0; background: linear-gradient(to bottom, #f8f9fa, #e9ecef); border-radius: 8px 8px 0 0; }
        .tab-btn { flex: 1; padding: 15px 10px; text-align: center; cursor: pointer; border: none; border-right: 1px solid #dee2e6; transition: all 0.3s ease; position: relative; }
        .tab-btn.active { background: #0066cc; color: white; }
        .tab-btn.active .ar-text { color: white; }
        .tab-btn.active .en-sub { color: rgba(255, 255, 255, 0.85); }
        
        .tab-content { display: none; padding: 20px 0; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef; }
        .load-step-title { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 5px; margin: 15px 0 10px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .load-step-title input { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; text-align: center; font-weight: bold; max-width: 200px; }
        
        .plate-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 15px; margin-bottom: 15px; color: white; }
        .plate-info-box input { background: rgba(255,255,255,0.9); border: none; border-radius: 4px; padding: 8px 12px; text-align: center; font-weight: bold; font-size: 1.1em; color: #333; }
        .global-actions { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 8px; padding: 15px; margin: 15px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .mpa-input { background-color: #fffde7 !important; border-bottom: 1px dashed #fbc02d !important; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª DIN Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .din-header { border-bottom: 4px solid #e67e22; padding-bottom: 10px; margin-bottom: 20px; }
        .din-result-box { background: #fff3e0; border: 2px solid #e67e22; border-radius: 10px; padding: 15px; text-align: center; margin-top: 20px; }
        .cycle-header { background: #e67e22; color: white; padding: 5px; font-weight: bold; margin-top: 15px; border-radius: 4px; text-align: center; }

        @media print {
            .no-print, .main-nav { display: none !important; }
            .view-section { display: none; }
            .view-section.active { display: block !important; }
            .tab-content { display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; overflow: visible !important; }
            .nav-buttons { display: none !important; }
            .page-break { page-break-before: always; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            body { padding: 0 !important; margin: 0 !important; font-size: 10pt; }
            .report-container { box-shadow: none; max-width: 100%; width: 100%; margin: 0; padding: 0; }
            .tabs-nav { display: none !important; }
            #tab1Content, #tab2Content { page-break-after: always; border-bottom: none !important; }
        }
    </style>
</head>
<body>

    <div class="main-nav no-print">
        <button class="std-btn active" onclick="switchStandard('ASTM')">ASTM D1194</button>
        <button class="std-btn" onclick="switchStandard('DIN')">DIN 18134</button>
    </div>

    <div id="view-ASTM" class="view-section active">
        <div class="report-container p-8">
            <div class="header-logo mb-6 flex items-center justify-between relative">
                <div class="w-1/4 flex justify-center items-center">
                    <img id="companyLogo" src="#" alt="Company Logo" class="max-h-24 object-contain hidden">
                    <div class="no-print text-center" id="uploadLogoBtnContainer">
                        <label for="logoInput" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded inline-block text-xs">
                            ğŸ“· Ø±ÙØ¹ Ù„ÙˆØ¬Ùˆ<br>Upload Logo
                        </label>
                        <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="loadLogo(event, 'ASTM')">
                    </div>
                </div>
                <div class="w-2/4 text-center">
                    <h1>
                        <span class="ar-text text-xl">ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­</span>
                        <small class="en-sub text-sm">PLATE LOAD TEST REPORT</small>
                    </h1>
                    <h2 class="text-lg text-gray-600">
                        <span class="ar-text">ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ù…ÙˆØ§ØµÙØ© ASTM D1194</span>
                        <small class="en-sub">According to ASTM D1194</small>
                    </h2>
                </div>
                <div class="w-1/4"></div>
            </div>

            <div class="no-print mb-4 flex gap-2 justify-center flex-wrap">
                <button onclick="window.print()" class="btn btn-success">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button onclick="generateChart()" class="btn btn-primary">ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</button>
            </div>

            <div class="section-title"><span class="ar-text">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span><small class="en-sub">PROJECT INFORMATION</small></div>
            <table class="mb-4">
                <tr>
                    <td class="label-cell w-1/4 bilingual-label"><span class="ar-text">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span><small class="en-sub">Project Name</small></td>
                    <td><input type="text" id="projectName"></td>
                    <td class="label-cell w-1/4 bilingual-label"><span class="ar-text">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span><small class="en-sub">Order No.</small></td>
                    <td><input type="text" id="orderNo"></td>
                </tr>
                <tr>
                    <td class="label-cell bilingual-label"><span class="ar-text">Ø§Ù„Ø¹Ù…ÙŠÙ„</span><small class="en-sub">Client</small></td>
                    <td><input type="text" id="client"></td>
                    <td class="label-cell bilingual-label"><span class="ar-text">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span><small class="en-sub">Test Date</small></td>
                    <td><input type="date" id="testDate"></td>
                </tr>
                <tr>
                    <td class="label-cell bilingual-label"><span class="ar-text">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><small class="en-sub">Location</small></td>
                    <td><input type="text" id="location"></td>
                    <td class="label-cell bilingual-label"><span class="ar-text">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span><small class="en-sub">Report Date</small></td>
                    <td><input type="date" id="reportDate"></td>
                </tr>
            </table>

            <div class="bg-blue-50 p-4 rounded mb-4 border border-blue-200 no-print">
                <div class="flex flex-wrap justify-center gap-6 items-center">
                    <label class="font-bold text-blue-900">
                        ÙˆØ­Ø¯Ø© Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Gauge Unit):
                        <select id="gauge_unit" class="p-1 border rounded dir-ltr" onchange="updateCalculations()">
                            <option value="MPa">MPa (Ù…ÙŠØ¬Ø§Ø¨Ø§Ø³ÙƒØ§Ù„)</option>
                            <option value="Bar">Bar (Ø¨Ø§Ø±)</option>
                            <option value="psi">psi (Ø±Ø·Ù„/Ø¨ÙˆØµØ©Â²)</option>
                            <option value="kg_cm2">kg/cmÂ² (ÙƒØ¬Ù…/Ø³Ù…Â²)</option>
                        </select>
                    </label>
                    <span class="text-gray-400">|</span>
                    <label class="font-bold text-blue-900">
                        Ù‚Ø¯Ø±Ø© ØªØ­Ù…Ù„ Ø§Ù„ØªØ±Ø¨Ø© (Design Load):
                        <input type="number" id="design_load" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1.5" class="bg-white p-1 w-20 border rounded" oninput="autoUpdateStages()"> kg/cmÂ²
                    </label>
                </div>
                <div class="text-center mt-2 text-sm text-gray-500">
                    * Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ 6 Ø¨Ø§Ù„Ø£Ø³ÙÙ„.
                </div>
            </div>

            <div class="plate-info-box no-print">
                <div class="flex flex-wrap items-center justify-center gap-6">
                    <div class="text-center">
                        <div class="label bilingual-label"><span class="ar-text" style="color:white;">Ù‚Ø·Ø± Ø§Ù„Ù„ÙˆØ­ (Ø³Ù…)</span><small class="en-sub" style="color:rgba(255,255,255,0.85);">Plate Diameter (cm)</small></div>
                        <input type="number" id="plateDiameter" value="45.72" step="0.1" min="1" oninput="calculatePlateArea()" style="width:120px;">
                    </div>
                    <div class="text-center text-3xl" style="color:rgba(255,255,255,0.7);">â†’</div>
                    <div class="text-center">
                        <div class="label bilingual-label"><span class="ar-text" style="color:white;">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„ÙˆØ­ (Ø³Ù…Â²)</span><small class="en-sub" style="color:rgba(255,255,255,0.85);">Plate Area (cmÂ²)</small></div>
                        <input type="text" id="plateArea" readonly style="width:150px; background:#e8f4fc; color:#0066cc;">
                    </div>
                    <div class="text-center ml-4 pl-4 border-l border-white/30">
                         <div class="label bilingual-label"><span class="ar-text" style="color:#ffebb5;">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</span><small class="en-sub" style="color:rgba(255,255,255,0.85);">Conversion Factor</small></div>
                         <input type="number" id="ramFactor" value="16.428" style="width:100px; color:#c62828;" title="ÙŠØªÙ… Ø¶Ø±Ø¨ Ø§Ù„Ù…ÙŠØ¬Ø§Ø¨Ø§Ø³ÙƒØ§Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù†">
                    </div>
                </div>
            </div>

            <table class="mb-4" style="display:none;" id="plateInfoPrint">
                <tr>
                    <td class="label-cell w-1/4 bilingual-label"><span class="ar-text">Ù‚Ø·Ø± Ø§Ù„Ù„ÙˆØ­ (Ø³Ù…)</span><small class="en-sub">Plate Diameter (cm)</small></td>
                    <td id="plateDiameterPrint">45.72</td>
                    <td class="label-cell w-1/4 bilingual-label"><span class="ar-text">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„ÙˆØ­ (Ø³Ù…Â²)</span><small class="en-sub">Plate Area (cmÂ²)</small></td>
                    <td id="plateAreaPrint">1641.73</td>
                </tr>
            </table>

            <div class="global-actions no-print">
                <button onclick="calculateAllResults()" class="btn btn-info">ğŸ”„ Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                <button onclick="saveToLocal()" class="btn btn-success" style="background-color: #198754;">ğŸ’¾ Ø­ÙØ¸ Ù…Ø¤Ù‚Øª</button>
                <button onclick="loadFromLocal()" class="btn btn-warning" style="background-color: #ffc107; color:black;">ğŸ“‚ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                <button onclick="resetNewTest()" class="btn btn-danger">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>

            <div class="tabs-nav no-print" id="tabsNav">
                <button class="tab-btn active" onclick="switchTab(1)" id="tab1Btn"><span class="tab-indicator">1</span> <span class="ar-text">Ø§Ù„Ù‚Ø³Ù… Ø£ - Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</span><small class="en-sub">Section A - Loading Stage</small></button>
                <button class="tab-btn" onclick="switchTab(2)" id="tab2Btn"><span class="tab-indicator">2</span> <span class="ar-text">Ø§Ù„Ù‚Ø³Ù… Ø¨ - Ù…Ø±Ø­Ù„Ø© Ø±ÙØ¹ Ø§Ù„Ø­Ù…Ù„</span><small class="en-sub">Section B - Unloading Stage</small></button>
                <button class="tab-btn" onclick="switchTab(3)" id="tab3Btn"><span class="tab-indicator">3</span> <span class="ar-text">Ø§Ù„Ù‚Ø³Ù… Ø¬ - Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù…Ù†Ø­Ù†ÙŠØ§Øª</span><small class="en-sub">Section C - Results & Curves</small></button>
            </div>

            <div class="tab-content active" id="tab1Content">
                <div class="section-title"><span class="ar-text">Ø£- Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</span><small class="en-sub">A- LOADING STAGE</small></div>
                
                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel1" value="0.70 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading1')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading1Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading1Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading1Body"></tbody>
                </table>

                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel2" value="1.40 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading2')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading2Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading2Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading2Body"></tbody>
                </table>

                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel3" value="2.10 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading3')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading3Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading3Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading3Body"></tbody>
                </table>

                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel4" value="2.80 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading4')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading4Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading4Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading4Body"></tbody>
                </table>

                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel5" value="3.50 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading5')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading5Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading5Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading5Body"></tbody>
                </table>

                <div class="load-step-title"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="loadingStageLabel6" value="4.20 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addLoadingRow('loading6')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('loading6Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="loading6Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="loading6Body"></tbody>
                </table>

                <div class="nav-buttons no-print"><div></div><button onclick="switchTab(2)" class="btn btn-primary btn-nav"><span class="ar-text">Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</span> â†’</button></div>
            </div>

            <div class="tab-content" id="tab2Content">
                <div class="section-title"><span class="ar-text">Ø¨- Ù…Ø±Ø­Ù„Ø© Ø±ÙØ¹ Ø§Ù„Ø­Ù…Ù„</span><small class="en-sub">B- UNLOADING STAGE</small></div>

                <div class="load-step-title" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="unloadingStageLabel1" value="2.80 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addUnloadingRow('unloading1')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('unloading1Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="unloading1Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="unloading1Body"></tbody>
                </table>

                <div class="load-step-title" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="unloadingStageLabel2" value="1.40 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addUnloadingRow('unloading2')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('unloading2Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="unloading2Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="unloading2Body"></tbody>
                </table>

                <div class="load-step-title" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="bilingual-label"><span class="ar-text">Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯</span><small class="en-sub">Stress Level</small></div><input type="text" id="unloadingStageLabel3" value="0.00 kg/cmÂ²"></div>
                <div class="no-print mb-2 mt-2 text-center"><button onclick="addUnloadingRow('unloading3')" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button><button onclick="removeLastRow('unloading3Body')" class="btn btn-danger">- Ø­Ø°Ù</button></div>
                <table id="unloading3Table" class="mb-4">
                    <thead><tr><th class="bilingual-label">Ø§Ù„ÙˆÙ‚Øª<br><small>Time</small></th><th class="bilingual-label bg-yellow-50">Ø§Ù„Ø¶ØºØ·<br><span class="unit-disp">(MPa)</span></th><th class="bilingual-label bg-gray-50">Ø§Ù„Ø­Ù…Ù„<br><small>Ton</small></th><th>G1</th><th>G2</th><th>G3</th><th class="calculated">Avg</th><th class="calculated">Sett.</th><th class="stress-calculated">Stress</th><th>Temp</th><th class="no-print">X</th></tr></thead>
                    <tbody id="unloading3Body"></tbody>
                </table>

                <div class="nav-buttons no-print">
                    <button onclick="switchTab(1)" class="btn btn-warning btn-nav">â† <span class="ar-text">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
                    <button onclick="switchTab(3)" class="btn btn-primary btn-nav"><span class="ar-text">Ø§Ù„ØªØ§Ù„ÙŠ</span> â†’</button>
                </div>
            </div>

            <div class="tab-content" id="tab3Content">
                <div class="section-title"><span class="ar-text">Ù…Ù„Ø®Øµ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span><small class="en-sub">SUMMARY OF TEST RESULTS</small></div>
                <div class="no-print mb-2 mt-2 text-center">
                    <button onclick="addSummaryRow()" class="btn btn-primary">+ ØµÙ</button>
                    <button onclick="autoFillSummary()" class="btn btn-success">âš¡ ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ±Ø³Ù…</button>
                </div>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th class="bilingual-label"><span class="ar-text">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span><small class="en-sub">Stage</small></th>
                            <th class="bilingual-label"><span class="ar-text">Ø§Ù„Ø­Ù…Ù„ (Ø·Ù†)</span><small class="en-sub">Load (ton)</small></th>
                            <th class="calculated bilingual-label"><span class="ar-text">Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ (ÙƒØ¬Ù…/Ø³Ù…Â²)</span><small class="en-sub">Stress (kg/cmÂ²)</small></th>
                            <th class="bilingual-label"><span class="ar-text">Ø§Ù„Ù‡Ø¨ÙˆØ· (Ù…Ù…)</span><small class="en-sub">Settlement (mm)</small></th>
                            <th class="no-print bilingual-label">X</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody"></tbody>
                </table>

               <div class="section-title page-break mt-6"><span class="ar-text">Ø¬- Ø§Ù„Ù…Ù†Ø­Ù†ÙŠØ§Øª</span><small class="en-sub">C- CURVES (Stress vs Settlement)</small></div>
                
                <div class="mt-4 p-4 border border-gray-300" style="height: 500px;">
                    <canvas id="stressSettlementChart"></canvas>
                </div>

                <div class="mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-center shadow-sm">
                    <h3 class="text-indigo-900 font-bold text-lg mb-2">
                        <span class="ar-text">Ù…Ø¹Ø§Ù…Ù„ Ø±Ø¯ ÙØ¹Ù„ Ø§Ù„ØªØ±Ø¨Ø© (K-Value)</span>
                        <small class="en-sub block font-normal text-sm">Modulus of Subgrade Reaction</small>
                    </h3>
                    <div class="flex justify-center items-baseline gap-2 dir-ltr">
                        <span class="text-gray-600 font-bold">K = </span>
                        <span id="kValueResult" class="text-4xl font-bold text-indigo-700">0.00</span>
                        <span class="text-gray-500 font-bold">kg/cmÂ³</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        * Calculated based on maximum loading point (P/Î”)
                        <br> * ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù‚ØµÙ‰ Ù†Ù‚Ø·Ø© ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ / Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¨Ø§Ù„Ø³Ù…)
                    </p>
                </div>

                <div class="nav-buttons no-print">
                    <button onclick="switchTab(2)" class="btn btn-warning btn-nav">â† <span class="ar-text">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></button>
                    <div></div>
                </div>
            </div>

           <div class="mt-8 pt-4 border-t-2 border-gray-400">
                <table class="signature-section" style="border:none;">
                    <tr style="border:none;">
                        <td class="w-1/3 text-center p-4" style="border:none;">
                            <div class="border-t border-black pt-2 mt-8">
                                <input type="text" class="text-center w-full font-bold mb-1 bg-transparent" placeholder="Ø§Ù„Ø§Ø³Ù… / Name" style="border:none;">
                                <span class="ar-text block">ÙØ­Øµ Ø¨ÙˆØ§Ø³Ø·Ø©</span>
                                <small class="en-sub">Tested By</small>
                            </div>
                        </td>
                        <td class="w-1/3 text-center p-4" style="border:none;">
                            <div class="border-t border-black pt-2 mt-8">
                                <input type="text" class="text-center w-full font-bold mb-1 bg-transparent" placeholder="Ø§Ù„Ø§Ø³Ù… / Name" style="border:none;">
                                <span class="ar-text block">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø©</span>
                                <small class="en-sub">Checked By</small>
                            </div>
                        </td>
                        <td class="w-1/3 text-center p-4" style="border:none;">
                            <div class="border-t border-black pt-2 mt-8">
                                <input type="text" class="text-center w-full font-bold mb-1 bg-transparent" placeholder="Ø§Ù„Ø§Ø³Ù… / Name" style="border:none;">
                                <span class="ar-text block">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø©</span>
                                <small class="en-sub">Approved By</small>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            
            <div class="mt-8 mb-4 text-center border-t border-gray-300 pt-4">
                <p class="text-2xl font-bold text-indigo-800" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                    Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ù…/ Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚ØµØ¨ÙŠ
                </p>
                <p class="text-sm text-gray-500 font-semibold mt-1">
                    Developed By: Eng. Mohamed Ahmed Elkasaby
                </p>
            </div>
        </div>
    </div>

    <div id="view-DIN" class="view-section">
        <div class="report-container">
            <div class="header-logo mb-6 flex items-center justify-between relative">
                <div class="w-1/4 flex justify-center items-center">
                    <img id="companyLogo_DIN" src="#" class="max-h-24 object-contain hidden">
                    <div class="no-print text-center" id="upBtn_DIN">
                        <label class="cursor-pointer bg-gray-200 p-2 rounded text-xs">ğŸ“· Logo<input type="file" class="hidden" onchange="loadLogo(event, 'DIN')"></label>
                    </div>
                </div>
                <div class="w-2/4 text-center din-header">
                    <h1 class="text-xl font-bold">Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­ (DIN 18134)<br><span class="text-sm font-normal">Plate Loading Test</span></h1>
                    <h2 class="text-sm text-gray-600">Strain Modulus Ev Calculation</h2>
                </div>
                <div class="w-1/4"></div>
            </div>

            <table class="mb-4">
                <tr><th width="20%">Project</th><td><input type="text"></td><th width="20%">Date</th><td><input type="date"></td></tr>
                <tr><th>Client</th><td><input type="text"></td><th>Test No.</th><td><input type="text"></td></tr>
            </table>

            <div class="din-result-box" style="margin-top:0; margin-bottom:20px; padding:10px;">
                <div class="flex justify-center gap-10">
                    <label><b>Plate Diameter (d):</b> <input type="number" id="din_dia" value="300" style="width:60px;"> mm</label>
                    <label><b>Plate Radius (r):</b> <span id="din_rad">150</span> mm</label>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <div class="cycle-header">1st Loading Cycle</div>
                    <table id="dinTable1">
                        <thead><tr class="bg-gray-100"><th>Load (MN/mÂ²) (Ïƒ)</th><th>Settlement (mm) (s)</th><th class="no-print">Del</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="no-print text-center"><button class="btn btn-primary" onclick="addDinRow('dinTable1')">+</button></div>
                </div>
                <div>
                    <div class="cycle-header" style="background:#7f8c8d;">Unloading</div>
                    <table id="dinTableUnload">
                        <thead><tr class="bg-gray-100"><th>Load (MN/mÂ²)</th><th>Settlement (mm)</th><th class="no-print">Del</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="no-print text-center"><button class="btn btn-primary" onclick="addDinRow('dinTableUnload')">+</button></div>
                </div>
                <div>
                    <div class="cycle-header" style="background:#27ae60;">2nd Loading Cycle</div>
                    <table id="dinTable2">
                        <thead><tr class="bg-gray-100"><th>Load (MN/mÂ²)</th><th>Settlement (mm)</th><th class="no-print">Del</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="no-print text-center"><button class="btn btn-primary" onclick="addDinRow('dinTable2')">+</button></div>
                </div>
            </div>

            <div class="no-print text-center mt-6">
                <button class="btn btn-success" onclick="calcDIN()">ğŸš€ Calculate Ev</button>
            </div>

            <div class="din-result-box">
                <div class="flex justify-around items-center flex-wrap">
                    <div><div class="text-gray-600 text-sm">Ev1</div><div class="text-2xl font-bold text-blue-800" id="res_ev1">0.00 MN/mÂ²</div></div>
                    <div><div class="text-gray-600 text-sm">Ev2</div><div class="text-2xl font-bold text-green-800" id="res_ev2">0.00 MN/mÂ²</div></div>
                    <div><div class="text-gray-600 text-sm">Ratio</div><div class="text-3xl font-extrabold text-orange-600" id="res_ratio">0.00</div></div>
                </div>
            </div>

            <div class="mt-6" style="height: 500px; border:1px solid #ccc; padding:10px;">
                <canvas id="chartDIN"></canvas>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-400 text-center">
                <p>Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ù…/ Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚ØµØ¨ÙŠ</p>
            </div>
        </div>
    </div>

    <script>
        function switchStandard(std) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.std-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + std).classList.add('active');
            const btns = document.querySelectorAll('.std-btn');
            if(std === 'ASTM') btns[0].classList.add('active'); else btns[1].classList.add('active');
        }

        function loadLogo(e, type) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const img = document.getElementById('companyLogo_' + type);
                    if(img) img.src = evt.target.result;
                    
                    if(type === 'ASTM') {
                        const img1 = document.getElementById('companyLogo');
                        if(img1) { img1.src = evt.target.result; img1.classList.remove('hidden'); }
                        document.getElementById('uploadLogoBtnContainer').style.display = 'none';
                    } else {
                        img.classList.remove('hidden');
                        document.getElementById('upBtn_' + type).style.display = 'none';
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        /* --- ASTM LOGIC (Preserved Original + Upgrades) --- */
        let rowCounters = {};
        let summaryRowCount = 0;
        let chart = null;

        window.addEventListener('DOMContentLoaded', () => {
            calculatePlateArea();
            for (let i = 1; i <= 6; i++) { rowCounters[`loading${i}`] = 0; addLoadingRow(`loading${i}`); addLoadingRow(`loading${i}`); }
            for (let i = 1; i <= 3; i++) { rowCounters[`unloading${i}`] = 0; addUnloadingRow(`unloading${i}`); addUnloadingRow(`unloading${i}`); }
            addSummaryRow();
            document.getElementById('reportDate').valueAsDate = new Date();
            document.getElementById('plateInfoPrint').style.display = 'table';
            Chart.register(ChartDataLabels);
            generateChart();
            
            // ØªÙ‡ÙŠØ¦Ø© DIN Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            addDinRow('dinTable1'); addDinRow('dinTable1');
            addDinRow('dinTableUnload');
            addDinRow('dinTable2'); addDinRow('dinTable2');
        });

        // Ø¯ÙˆØ§Ù„ ASTM Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„ÙˆØ­Ø¯Ø§Øª)
        function calculatePlateArea() {
            const diameter = parseFloat(document.getElementById('plateDiameter').value);
            if (!isNaN(diameter) && diameter > 0) {
                const area = Math.PI * Math.pow(diameter / 2, 2);
                document.getElementById('plateArea').value = area.toFixed(2);
                document.getElementById('plateDiameterPrint').textContent = diameter;
                document.getElementById('plateAreaPrint').textContent = area.toFixed(2);
            }
        }
        function getPlateArea() {
            const areaValue = parseFloat(document.getElementById('plateArea').value);
            return isNaN(areaValue) ? 1641.73 : areaValue;
        }
        function switchTab(tabNumber) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab${tabNumber}Content`).classList.add('active');
            document.getElementById(`tab${tabNumber}Btn`).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (tabNumber === 3) setTimeout(generateChart, 100);
        }

        function addLoadingRow(tableId) {
            if (!rowCounters[tableId]) rowCounters[tableId] = 0;
            rowCounters[tableId]++;
            const tbody = document.getElementById(`${tableId}Body`);
            const row = document.createElement('tr');
            row.id = `${tableId}-row-${rowCounters[tableId]}`;
            row.innerHTML = `
                <td><input type="text" class="print-compact" placeholder="HH:MM"></td>
                <td class="bg-yellow-50"><input type="number" step="0.001" class="mpa-input print-compact" oninput="calculateRow(this)" placeholder="Pressure"></td>
                <td class="bg-gray-50"><input type="number" step="0.01" class="load-input print-compact" onchange="calculateRow(this)" readonly></td>
                <td><input type="number" step="0.001" class="gauge-input print-compact" onchange="calculateRow(this)"></td>
                <td><input type="number" step="0.001" class="gauge-input print-compact" onchange="calculateRow(this)"></td>
                <td><input type="number" step="0.001" class="gauge-input print-compact" onchange="calculateRow(this)"></td>
                <td class="calculated average-cell">-</td>
                <td class="calculated settlement-cell">-</td>
                <td class="stress-calculated stress-cell">-</td>
                <td><input type="number" step="0.1" class="print-compact" placeholder="Â°C"></td>
                <td class="no-print"><button onclick="removeRow('${row.id}')" class="btn btn-danger btn-sm" style="padding:0px 6px;">âœ•</button></td>
            `;
            tbody.appendChild(row);
        }

        function addUnloadingRow(tableId) { addLoadingRow(tableId); }

        function calculateRow(input) {
            const row = input.closest('tr');
            const gaugeInputs = row.querySelectorAll('.gauge-input');
            const loadInput = row.querySelector('.load-input');
            const mpaInput = row.querySelector('.mpa-input');
            
            const unit = document.getElementById('gauge_unit').value;
            let gaugeValue = parseFloat(mpaInput.value);
            
            if (!isNaN(gaugeValue)) {
                let pressureMPa = 0;
                if (unit === 'MPa') pressureMPa = gaugeValue;
                else if (unit === 'Bar') pressureMPa = gaugeValue / 10;
                else if (unit === 'psi') pressureMPa = gaugeValue / 145.038;
                else if (unit === 'kg_cm2') pressureMPa = gaugeValue / 10.197;

                const factor = parseFloat(document.getElementById('ramFactor').value) || 16.428;
                let loadTon = pressureMPa * factor;
                loadInput.value = loadTon.toFixed(2);

                const area = getPlateArea();
                row.querySelector('.stress-cell').textContent = ((loadTon * 1000) / area).toFixed(2);
            }

            let sum = 0, count = 0;
            gaugeInputs.forEach(g => { if(g.value!=='') { sum+=parseFloat(g.value); count++; } });
            if (count === 3) {
                const avg = sum / 3;
                row.querySelector('.average-cell').textContent = avg.toFixed(3);
                row.querySelector('.settlement-cell').textContent = (avg * 0.001).toFixed(3);
            }
        }

        function updateCalculations() {
            const unit = document.getElementById('gauge_unit').value;
            const labels = document.querySelectorAll('.unit-disp');
            labels.forEach(l => l.innerText = `(${unit})`);
            document.querySelectorAll('.mpa-input').forEach(inp => calculateRow(inp));
        }

        function autoUpdateStages() {
            const designLoad = parseFloat(document.getElementById('design_load').value);
            if(isNaN(designLoad) || designLoad <= 0) return;
            const multipliers = [0.50, 1.00, 1.50, 2.00, 2.50, 3.00];
            for(let i=1; i<=6; i++) {
                let val = (designLoad * multipliers[i-1]).toFixed(2);
                document.getElementById(`loadingStageLabel${i}`).value = `${val} kg/cmÂ²`;
            }
            document.getElementById(`unloadingStageLabel1`).value = `${(designLoad * 2.00).toFixed(2)} kg/cmÂ²`;
            document.getElementById(`unloadingStageLabel2`).value = `${(designLoad * 1.00).toFixed(2)} kg/cmÂ²`;
            document.getElementById(`unloadingStageLabel3`).value = `0.00 kg/cmÂ²`;
        }

        function addSummaryRow() {
            summaryRowCount++;
            const tbody = document.getElementById('summaryBody');
            const row = document.createElement('tr');
            row.id = `summary-row-${summaryRowCount}`;
            row.innerHTML = `
                <td><select class="stage-select print-compact" onchange="generateChart()" style="border:none;background:transparent;"><option value="Loading">ØªØ­Ù…ÙŠÙ„</option><option value="Unloading">Ø±ÙØ¹</option></select></td>
                <td><input type="number" step="0.01" class="load-input print-compact" oninput="calculateStressSummary(this)"></td>
                <td class="calculated stress-cell">-</td>
                <td><input type="number" step="0.001" class="settlement-input print-compact" oninput="generateChart()"></td>
                <td class="no-print"><button onclick="removeRow('${row.id}'); generateChart()" class="btn btn-danger btn-sm">âœ•</button></td>
            `;
            tbody.appendChild(row);
        }

        function calculateStressSummary(input) {
            const row = input.closest('tr');
            const load = parseFloat(input.value);
            if (!isNaN(load)) {
                const area = getPlateArea();
                row.querySelector('.stress-cell').textContent = ((load * 1000) / area).toFixed(2);
            }
            generateChart();
        }

        function autoFillSummary() {
            document.getElementById('summaryBody').innerHTML = '';
            summaryRowCount = 0;
            addSummaryRow();
            let r = document.getElementById(`summary-row-${summaryRowCount}`);
            r.querySelector('.stage-select').value = 'Loading';
            r.querySelector('.load-input').value = '0.00';
            r.querySelector('.settlement-input').value = '0.000';
            r.querySelector('.stress-cell').textContent = '0.00';

            for (let i = 1; i <= 6; i++) {
                const rows = document.querySelectorAll(`#loading${i}Body tr`);
                if (rows.length > 0) {
                    const last = rows[rows.length - 1];
                    if (last.querySelector('.load-input').value) {
                        addSummaryRow();
                        r = document.getElementById(`summary-row-${summaryRowCount}`);
                        r.querySelector('.stage-select').value = 'Loading';
                        r.querySelector('.load-input').value = last.querySelector('.load-input').value;
                        r.querySelector('.settlement-input').value = last.querySelector('.settlement-cell').textContent;
                        r.querySelector('.stress-cell').textContent = last.querySelector('.stress-cell').textContent;
                    }
                }
            }
            for (let i = 1; i <= 3; i++) {
                const rows = document.querySelectorAll(`#unloading${i}Body tr`);
                if (rows.length > 0) {
                    const last = rows[rows.length - 1];
                    if (last.querySelector('.load-input').value) {
                        addSummaryRow();
                        r = document.getElementById(`summary-row-${summaryRowCount}`);
                        r.querySelector('.stage-select').value = 'Unloading';
                        r.querySelector('.load-input').value = last.querySelector('.load-input').value;
                        r.querySelector('.settlement-input').value = last.querySelector('.settlement-cell').textContent;
                        r.querySelector('.stress-cell').textContent = last.querySelector('.stress-cell').textContent;
                    }
                }
            }
            generateChart();
        }

        function generateChart() {
            const rows = document.querySelectorAll('#summaryBody tr');
            const loadingData = [], unloadingData = [];
            rows.forEach(row => {
                const stage = row.querySelector('.stage-select').value;
                const stress = parseFloat(row.querySelector('.stress-cell').textContent);
                const sett = parseFloat(row.querySelector('.settlement-input').value);
                if (!isNaN(stress) && !isNaN(sett)) {
                    const pt = { x: stress, y: sett };
                    if (stage === 'Loading') loadingData.push(pt); 
                    else unloadingData.push(pt);
                }
            });
            loadingData.sort((a,b) => a.x - b.x);
            unloadingData.sort((a,b) => b.x - a.x);

            const ctx = document.getElementById('stressSettlementChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Loading', data: loadingData, borderColor: '#1F4E79', backgroundColor: '#C00000', pointBackgroundColor: '#C00000', pointBorderColor: '#C00000', pointStyle: 'rectRot', pointRadius: 5, borderWidth: 2, tension: 0, fill: false },
                        { label: 'Unloading', data: unloadingData, borderColor: '#1F4E79', backgroundColor: '#C00000', pointBackgroundColor: '#C00000', pointBorderColor: '#C00000', pointStyle: 'rectRot', pointRadius: 5, borderWidth: 2, borderDash: [], tension: 0, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 30, right: 30, left: 10, bottom: 10 } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false }, datalabels: { display: true, align: 'right', anchor: 'center', offset: 6, color: '#000', font: { weight: 'bold', size: 11 }, formatter: (v) => v.y.toFixed(3) } },
                    scales: {
                        x: { type: 'linear', position: 'top', title: { display: true, text: 'Stress (kg/cmÂ²)', font: {weight:'bold', size: 12}, color: '#000' }, min: 0, max: 4.5, grid: { color: '#000', lineWidth: 0.5 }, ticks: { color: '#000', font: {weight:'bold'} } },
                        y: { reverse: true, title: { display: true, text: 'Settlement (mm)', font: {weight:'bold', size: 12}, color: '#000' }, min: 0, grid: { color: '#000', lineWidth: 0.5 }, ticks: { color: '#000', font: {weight:'bold'} } }
                    }
                }
            });
            calculateKValue(loadingData);
        }

        function saveToLocal() {
            const data = {
                project: {
                    name: document.getElementById('projectName').value,
                    order: document.getElementById('orderNo').value,
                    client: document.getElementById('client').value,
                    date: document.getElementById('testDate').value,
                    location: document.getElementById('location').value,
                    reportDate: document.getElementById('reportDate').value,
                    plateDiameter: document.getElementById('plateDiameter').value,
                    ramFactor: document.getElementById('ramFactor').value
                },
                loadingTables: {},
                unloadingTables: {}
            };
            for (let i = 1; i <= 6; i++) data.loadingTables[`loading${i}`] = getTableData(`loading${i}`);
            for (let i = 1; i <= 3; i++) data.unloadingTables[`unloading${i}`] = getTableData(`unloading${i}`);
            localStorage.setItem('plateTestBackup', JSON.stringify(data));
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹!');
        }

        function calculateKValue(loadingData) {
            if (!loadingData || loadingData.length === 0) { document.getElementById('kValueResult').textContent = "0.00"; return; }
            const lastPoint = loadingData[loadingData.length - 1];
            const stress = lastPoint.x; const settlementMM = lastPoint.y;
            if (settlementMM > 0) {
                const settlementCM = settlementMM / 10;
                const kVal = stress / settlementCM;
                document.getElementById('kValueResult').textContent = kVal.toFixed(2);
            } else { document.getElementById('kValueResult').textContent = "0.00"; }
        }

        function getTableData(tableId) {
            const rows = [];
            document.querySelectorAll(`#${tableId}Body tr`).forEach(tr => {
                rows.push({
                    time: tr.querySelector('td:nth-child(1) input').value,
                    mpa: tr.querySelector('.mpa-input').value, 
                    g1: tr.querySelectorAll('.gauge-input')[0].value,
                    g2: tr.querySelectorAll('.gauge-input')[1].value,
                    g3: tr.querySelectorAll('.gauge-input')[2].value,
                    temp: tr.querySelector('td:nth-child(10) input').value
                });
            });
            return rows;
        }

        function loadFromLocal() {
            const json = localStorage.getItem('plateTestBackup');
            if (!json) { alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©!'); return; }
            if(!confirm('Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ (Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)')) return;
            const data = JSON.parse(json);
            document.getElementById('projectName').value = data.project.name;
            document.getElementById('orderNo').value = data.project.order;
            document.getElementById('client').value = data.project.client;
            document.getElementById('testDate').value = data.project.date;
            document.getElementById('location').value = data.project.location;
            document.getElementById('reportDate').value = data.project.reportDate;
            document.getElementById('plateDiameter').value = data.project.plateDiameter;
            document.getElementById('ramFactor').value = data.project.ramFactor;
            calculatePlateArea();
            const restore = (id, rows) => {
                const body = document.getElementById(`${id}Body`);
                body.innerHTML = ''; rowCounters[id] = 0;
                if(rows) rows.forEach(r => {
                    id.includes('unloading') ? addUnloadingRow(id) : addLoadingRow(id);
                    const tr = body.lastElementChild;
                    tr.querySelector('td:nth-child(1) input').value = r.time;
                    tr.querySelector('.mpa-input').value = r.mpa;
                    tr.querySelectorAll('.gauge-input')[0].value = r.g1;
                    tr.querySelectorAll('.gauge-input')[1].value = r.g2;
                    tr.querySelectorAll('.gauge-input')[2].value = r.g3;
                    tr.querySelector('td:nth-child(10) input').value = r.temp;
                    calculateRow(tr.querySelector('.mpa-input'));
                });
            };
            for (let i = 1; i <= 6; i++) restore(`loading${i}`, data.loadingTables[`loading${i}`]);
            for (let i = 1; i <= 3; i++) restore(`unloading${i}`, data.unloadingTables[`unloading${i}`]);
            autoFillSummary();
            alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹!');
        }

        function removeRow(id) { document.getElementById(id)?.remove(); }
        function removeLastRow(id) { const b = document.getElementById(id); if(b.lastChild) b.removeChild(b.lastChild); }
        function resetNewTest() { if(confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) location.reload(); }
        function calculateAllResults() { autoFillSummary(); alert('ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«'); }

        /* --- DIN LOGIC --- */
        function polyFit(xArr, yArr) {
            if (typeof math === 'undefined') return [0,0,0];
            let n = xArr.length;
            let sumX=0, sumX2=0, sumX3=0, sumX4=0, sumY=0, sumXY=0, sumX2Y=0;
            for(let i=0; i<n; i++) {
                let x = xArr[i], y = yArr[i];
                sumX+=x; sumX2+=x*x; sumX3+=x*x*x; sumX4+=x*x*x*x;
                sumY+=y; sumXY+=x*y; sumX2Y+=x*x*y;
            }
            let A = [[n, sumX, sumX2], [sumX, sumX2, sumX3], [sumX2, sumX3, sumX4]];
            let B = [sumY, sumXY, sumX2Y];
            try { let X = math.lusolve(A, B); return [Number(X[0]), Number(X[1]), Number(X[2])]; } 
            catch(e) { return [0,0,0]; }
        }

        let chartDIN_Obj = null;
        function addDinRow(tableId) {
            const row = `<tr><td><input type="number" step="0.01"></td><td><input type="number" step="0.01"></td><td class="no-print"><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">x</button></td></tr>`;
            document.getElementById(tableId).querySelector('tbody').insertAdjacentHTML('beforeend', row);
        }
        document.getElementById('din_dia').addEventListener('input', function() {
            document.getElementById('din_rad').innerText = (this.value / 2).toFixed(1);
        });

        function calcDIN() {
            let getData = (id) => {
                let arr = [];
                document.querySelectorAll(`#${id} tbody tr`).forEach(tr => {
                    let ins = tr.querySelectorAll('input');
                    let s = parseFloat(ins[0].value), set = parseFloat(ins[1].value);
                    if(!isNaN(s) && !isNaN(set)) arr.push({x:s, y:set});
                });
                return arr;
            };
            let data1 = getData('dinTable1'), dataUn = getData('dinTableUnload'), data2 = getData('dinTable2');
            if(data1.length < 3 || data2.length < 3) { alert("Add points!"); return; }

            let r_mm = parseFloat(document.getElementById('din_rad').innerText);
            let sigma_max1 = data1[data1.length-1].x;

            let x1 = data1.map(p=>p.x), y1 = data1.map(p=>p.y);
            let coeffs1 = polyFit(x1, y1);
            let Ev1 = 1.5 * r_mm * (1 / (coeffs1[1] + coeffs1[2] * sigma_max1));

            let x2 = data2.map(p=>p.x), y2 = data2.map(p=>p.y);
            let coeffs2 = polyFit(x2, y2);
            let Ev2 = 1.5 * r_mm * (1 / (coeffs2[1] + coeffs2[2] * sigma_max1)); 
            
            document.getElementById('res_ev1').innerText = Ev1.toFixed(2) + " MN/mÂ²";
            document.getElementById('res_ev2').innerText = Ev2.toFixed(2) + " MN/mÂ²";
            document.getElementById('res_ratio').innerText = (Ev2/Ev1).toFixed(2);

            let genCurve = (coeffs, maxX) => {
                let pts = [];
                for(let x=0; x<=maxX; x+=maxX/20) pts.push({x: x, y: coeffs[0] + coeffs[1]*x + coeffs[2]*x*x});
                return pts;
            };
            let curve1 = genCurve(coeffs1, sigma_max1);
            let curve2 = genCurve(coeffs2, data2[data2.length-1].x);

            if(chartDIN_Obj) chartDIN_Obj.destroy();
            const ctx = document.getElementById('chartDIN').getContext('2d');
            chartDIN_Obj = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Cycle 1', data: data1, backgroundColor: 'blue' },
                        { label: 'Fit 1', data: curve1, type:'line', borderColor:'blue', pointRadius:0, fill:false },
                        { label: 'Unload', data: dataUn, type:'line', borderColor:'gray', borderDash:[5,5], fill:false },
                        { label: 'Cycle 2', data: data2, backgroundColor: 'green' },
                        { label: 'Fit 2', data: curve2, type:'line', borderColor:'green', pointRadius:0, fill:false }
                    ]
                },
                options: {
                    scales: {
                        x: { type:'linear', position:'top', title:{display:true, text:'Stress (MN/mÂ²)'} },
                        y: { reverse:true, title:{display:true, text:'Settlement (mm)'} }
                    }
                }
            });
        }
    </script>
</body>
</html>
